{"version":3,"file":"routing.js","sourceRoot":"","sources":["../../src/global-state/routing.ts"],"names":[],"mappings":"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","sourcesContent":["import { type NavigationAction, type NavigationState } from '@react-navigation/native';\nimport * as Linking from 'expo-linking';\n\nimport type { RouterStore } from './router-store';\nimport { ResultState } from '../fork/getStateFromPath';\nimport { Href, resolveHref } from '../link/href';\nimport { resolve } from '../link/path';\nimport { hasUrlProtocolPrefix } from '../utils/url';\n\nfunction assertIsReady(store: RouterStore) {\n  if (!store.navigationRef.isReady()) {\n    throw new Error(\n      'Attempted to navigate before mounting the Root Layout component. Ensure the Root Layout component is rendering a Slot, or other navigator on the first render.'\n    );\n  }\n}\n\nexport function navigate(this: RouterStore, url: Href) {\n  return this.linkTo(resolveHref(url));\n}\n\nexport function push(this: RouterStore, url: Href) {\n  return this.linkTo(resolveHref(url), 'PUSH');\n}\n\nexport function replace(this: RouterStore, url: Href) {\n  return this.linkTo(resolveHref(url), 'REPLACE');\n}\n\nexport function goBack(this: RouterStore) {\n  assertIsReady(this);\n  this.navigationRef?.current?.goBack();\n}\n\nexport function canGoBack(this: RouterStore): boolean {\n  // Return a default value here if the navigation hasn't mounted yet.\n  // This can happen if the user calls `canGoBack` from the Root Layout route\n  // before mounting a navigator. This behavior exists due to React Navigation being dynamically\n  // constructed at runtime. We can get rid of this in the future if we use\n  // the static configuration internally.\n  if (!this.navigationRef.isReady()) {\n    return false;\n  }\n  return this.navigationRef?.current?.canGoBack() ?? false;\n}\n\nexport function setParams(this: RouterStore, params: Record<string, string | number> = {}) {\n  assertIsReady(this);\n  return (this.navigationRef?.current?.setParams as any)(params);\n}\n\nexport function linkTo(this: RouterStore, href: string, event?: string) {\n  if (hasUrlProtocolPrefix(href)) {\n    Linking.openURL(href);\n    return;\n  }\n\n  assertIsReady(this);\n  const navigationRef = this.navigationRef.current;\n\n  if (navigationRef == null) {\n    throw new Error(\n      \"Couldn't find a navigation object. Is your component inside NavigationContainer?\"\n    );\n  }\n\n  if (!this.linking) {\n    throw new Error('Attempted to link to route when no routes are present');\n  }\n\n  if (href === '..' || href === '../') {\n    navigationRef.goBack();\n    return;\n  }\n\n  if (href.startsWith('.')) {\n    let base =\n      this.linking.getPathFromState?.(navigationRef.getRootState(), {\n        screens: [],\n        preserveGroups: true,\n      }) ?? '';\n\n    if (base && !base.endsWith('/')) {\n      base += '/..';\n    }\n    href = resolve(base, href);\n  }\n\n  const state = this.linking.getStateFromPath!(href, this.linking.config);\n\n  if (!state || state.routes.length === 0) {\n    console.error('Could not generate a valid navigation state for the given path: ' + href);\n    return;\n  }\n\n  switch (event) {\n    case 'REPLACE':\n      return navigationRef.dispatch(getNavigateReplaceAction(state, navigationRef.getRootState()));\n    case 'PUSH':\n      return navigationRef.dispatch(getNavigatePushAction(state, navigationRef.getRootState()));\n    default:\n      return navigationRef.dispatch(getNavigateAction(state));\n  }\n}\n\ntype NavigationParams = Partial<{\n  screen: string;\n  params: NavigationParams;\n}>;\n\nfunction rewriteNavigationStateToParams(\n  state?: { routes: ResultState['routes'] } | NavigationState,\n  params: NavigationParams = {}\n) {\n  if (!state) return params;\n  // We Should always have at least one route in the state\n  const lastRoute = state.routes.at(-1)!;\n  params.screen = lastRoute.name;\n  // Weirdly, this always needs to be an object. If it's undefined, it won't work.\n  params.params = lastRoute.params ? JSON.parse(JSON.stringify(lastRoute.params)) : {};\n\n  if (lastRoute.state) {\n    rewriteNavigationStateToParams(lastRoute.state, params.params);\n  }\n\n  return JSON.parse(JSON.stringify(params));\n}\nfunction getNavigateAction(state: ResultState) {\n  const { screen, params } = rewriteNavigationStateToParams(state);\n  return {\n    type: 'NAVIGATE',\n    payload: {\n      name: screen,\n      params,\n    },\n  };\n}\n\nfunction getNavigatePushAction(desiredState: ResultState, navigationState: NavigationState) {\n  debugger;\n  const sharedParents = getSharedNavigators(desiredState, navigationState, false);\n\n  if (sharedParents && sharedParents.at(-1)?.type === 'stack') {\n    const { screen, params } = rewriteNavigationStateToParams(desiredState);\n    return {\n      type: 'PUSH',\n      payload: {\n        name: screen,\n        params,\n      },\n    };\n  } else {\n    return getNavigateAction(desiredState);\n  }\n}\n\nfunction getNavigateReplaceAction(\n  desiredState: ResultState,\n  navigationState: NavigationState\n): NavigationAction {\n  const sharedParents = getSharedNavigators(desiredState, navigationState);\n  const lastNavigatorSupportingReplace =\n    sharedParents?.findLast((parent) => parent.type === 'stack' || parent.type === 'tab') ?? -1;\n\n  if (lastNavigatorSupportingReplace === -1) {\n    throw new Error();\n  }\n\n  const { screen, params } = rewriteNavigationStateToParams(desiredState);\n\n  return {\n    type: lastNavigatorSupportingReplace.type === 'stack' ? 'REPLACE' : 'JUMP_TO',\n    payload: {\n      name: screen,\n      params,\n      // Ensure that the last navigator supporting replace is the one that handles the action\n      source: lastNavigatorSupportingReplace?.key,\n    },\n  };\n}\n\nfunction getSharedNavigators(\n  left: ResultState,\n  right: NavigationState,\n  allowPartial = true,\n  shared: NavigationState[] = []\n) {\n  shared.push(right);\n\n  const leftRoute = left.routes.at(-1)!;\n  const matchedRoute = right.routes.find((route) => route.name === leftRoute.name);\n  const routesShareNavigator = right.routes[right.index] === matchedRoute;\n\n  if (routesShareNavigator && leftRoute.state && matchedRoute.state) {\n    return getSharedNavigators(\n      leftRoute.state,\n      matchedRoute.state as NavigationState,\n      allowPartial,\n      shared\n    );\n  }\n\n  const isPartialMatch = shared.length > 1 || leftRoute.state || matchedRoute?.state;\n\n  if (allowPartial && isPartialMatch) {\n    return shared;\n  } else if (!isPartialMatch) {\n    return shared;\n  }\n\n  return undefined;\n}\n"]}